(function () {
  // BDVBurik 2024
  "use strict";

  let www = ``;
  let year;
  let namemovie;
  const urlEndTMDB = "?language=en-US&api_key=4ef0d7355d9ffb5151e987764708ce96";

  const tmdbApiUrl = "https://api.themoviedb.org/3/";
  let kp_prox = "https://worker-patient-dream-26d7.bdvburik.workers.dev:8443/";
  let url = "https://rezka.ag/ajax/get_comments/?t=1714093694732&news_id=";

  // Создание элемента визуализации загрузки
  function createLoader() {
    const loader = document.createElement("div");
    loader.id = "loader";
    loader.innerHTML = `
      <div class="spinner"></div>
      <style>
        #loader {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        }
        .spinner {
          border: 16px solid #f3f3f3;
          border-top: 16px solid #3498db;
          border-radius: 50%;
          width: 120px;
          height: 120px;
          animation: spin 2s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    `;
    document.body.appendChild(loader);
  }

  // Удаление элемента визуализации загрузки
  function removeLoader() {
    const loader = document.getElementById("loader");
    if (loader) {
      document.body.removeChild(loader);
    }
  }

  // Функция для поиска на сайте hdrezka
  async function searchRezka(name, ye) {
    createLoader(); // Показать визуализацию загрузки
    try {
      let fc = await fetch(
        kp_prox +
          "https://hdrezka.ag/search/?do=search&subaction=search&q=" +
          name +
          (ye ? "+" + ye : ""),
        {
          method: "GET",
          headers: {
            "Content-Type": "text/html",
          },
        }
      ).then((response) => response.text());

      let dom = new DOMParser().parseFromString(fc, "text/html");

      let arr = Array.from(dom.getElementsByClassName("b-content__inline_item"));
      namemovie = arr[0].childNodes[3].innerText;

      comment_rezka(arr[0].dataset.id);
    } catch (error) {
      console.error("Error fetching search results:", error);
    } finally {
      removeLoader(); // Скрыть визуализацию загрузки
    }
  }

  // Функция для получения английского названия фильма или сериала
  async function getEnTitle(id, type) {
    let url;

    if (type === "movie") {
      url = kp_prox + tmdbApiUrl + "movie/" + id + urlEndTMDB;
    } else {
      url = kp_prox + tmdbApiUrl + "tv/" + id + urlEndTMDB;
    }

    ennTitle(url);
  }

  async function ennTitle(url) {
    let enTitle;
    try {
      await fetch(url)
        .then((response) => response.json())
        .then((e) => (enTitle = e.title || e.name));
      searchRezka(normalizeTitle(enTitle), year);
    } catch (error) {
      console.error("Error fetching English title:", error);
    }
  }

  // Функция для очистки заголовка от лишних символов
  function cleanTitle(str) {
    return str.replace(/[\s.,:;’'`!?]+/g, " ").trim();
  }

  // Функция для нормализации заголовка
  function normalizeTitle(str) {
    return cleanTitle(
      str
        .toLowerCase()
        .replace(/[\-\u2010-\u2015\u2E3A\u2E3B\uFE58\uFE63\uFF0D]+/g, "-")
        .replace(/ё/g, "е")
    );
  }

  // Функция для получения комментариев с сайта rezka
  async function comment_rezka(id) {
    createLoader(); // Показать визуализацию загрузки
    try {
      let fc = await fetch(
        kp_prox +
          url +
          (id ? id : "1") +
          "&cstart=1&type=0&comment_id=0&skin=hdrezka",
        {
          method: "GET",
          headers: { "Content-Type": "text/plain" },
        }
      )
        .then((response) => response.json())
        .then((qwe) => qwe);

      let dom = new DOMParser().parseFromString(fc.comments, "text/html");
      dom
        .querySelectorAll(".ava, .actions, i, .share-link")
        .forEach((elem) => elem.remove());

      dom
        .querySelectorAll(".message")
        .forEach((e) => e.parentNode.parentNode.before(e));
      dom.querySelectorAll(".info").forEach((e) => {
        e.childNodes[5].remove();
        e.classList.add("myinfo");
        e.classList.remove("info");
      });

      //console.log("dom", dom);
      let arr = dom.getElementsByClassName("comments-tree-list");
      www = arr[0].outerHTML;

      let Script = document.createElement("Script");
      Script.innerHTML = `function ShowOrHide(id) {var text = $("#" + id);text.prev(".title_spoiler").remove();text.css("display", "inline");}`;
      document.head.appendChild(Script);
      var modal = $(
        `<div> <div class="broadcast__text" style="text-align:left;"><div class="comment" style="margin-left: -15px;">` +
          www +
          "</div></div></div>"
      ); //.style.color = "blue"
      let styleEl = document.createElement("style");
      styleEl.setAttribute("type", "text/css");
      styleEl.innerHTML = `
      .scroll--mask{
        margin-top: 10px;
      }
      .title_spoiler a {
        border-radius: 8px;
        background-color: #5d5b5b;
        color: #fff;
        padding: 0 2px 0 5px;
        position: relative;
        text-decoration: none;
      }
      .text_spoiler {
        background-color: #353333;
      }
      .comments-tree-item {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .b-comment .message {
        float: right;
        width: 100%;
        padding-bottom: 10px;
      }
      .myinfo {
        margin-top: 10px;
        border-top: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        font-size: 0.6em;
        color: #cfc9be;
      }
      div.text > div {
        display: ruby-text;

        padding-left: 1.2em;
      }
      `;
      document.head.appendChild(styleEl);

      var enabled = Lampa.Controller.enabled().name;
      Lampa.Modal.open({
        title: ``,
        html: modal,
        size: "large",
        style: "margin-top:10px;",
        mask: !0,
        onBack: function () {
          Lampa.Modal.close(), Lampa.Controller.toggle(enabled);
          $(".modal--large").remove();
          www = "";
        },
        onSelect: function () {},
      });
      $(".modal__head").after(
        `${namemovie}<button class="selector "  tabindex="0" style = "float: right;" type="button"  onclick="$('.modal--large').remove()"  data-dismiss="modal">&times;</button>`
      );
    } catch (error) {
      console.error("Error fetching comments:", error);
    } finally {
      removeLoader(); // Скрыть визуализацию загрузки
    }
  }

  // Функция для начала работы плагина
  function startPlugin() {
    window.comment_plugin = true;
    Lampa.Listener.follow("full", function (e) {
      if (e.type == "complite") {
        $(".button--comment").remove();
        $(".full-start-new__buttons").append(
          `<div class="full-start__button selector button--comment"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" x="0" y="0" viewBox="0 0 48 48"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M44,28c-1.1,0-2.1-0.4-2.9-1.1L33,21.5l-6.4,6.4c-1.6,1.6-4.1,1.8-5.9,0.5c-1.6-1.6-1.8-4.1-0.5-5.9l8.3-8.3c-0.1-0.2-0.2-0.3-0.3-0.5c-0.4-0.6-0.7-1.1-1.2-1.5L17.3,3.6c-1.6-1.6-4.1-1.8-5.9-0.5c-1.6,1.6-1.8,4.1-0.5,5.9l8.3,8.3c-0.1,0.2-0.2,0.3-0.3,0.5c-0.4,0.6-0.7,1.1-1.2,1.5L5.5,23.4C4.1,24.8,3.9,27.3,5.5,28.9c1.6,1.6,4.1,1.8,5.9,0.5l8.4-8.4c0.2-0.2,0.3-0.5,0.5-0.8l7.1,7.1c0.5,0.5,1,1,1.6,1.4c0.7,0.5,1.4,0.8,2.3,0.8c1.1,0,2.1-0.4,2.9-1.1l8.3-8.3c1.6-1.6,1.8-4.1,0.5-5.9C46.1,28.3,45.1,28,44,28z"></path></g></svg><span style="margin-left: 10px;">Comments</span></div>`
        );
        $(".full-start__button").on("click", async function () {
          const current_id = $(".full-start__title").data("id");
          const full_start_name = $(".full-start__title").text();
          year = $(".full-start__description").text().match(/(\d{4})/);
          year = year ? year[0] : "";

          let imdb_id = Lampa.Utils.imdb_id(current_id);
          let kp_id = Lampa.Utils.kp_id(current_id);

          if (kp_id) {
            getEnTitle(kp_id, "movie");
          } else if (imdb_id) {
            getEnTitle(imdb_id, "movie");
          } else {
            searchRezka(normalizeTitle(full_start_name), year);
          }
        });
      }
    });
  }

  // Запуск плагина после загрузки страницы
  Lampa.Controller.add("comment_plugin", startPlugin);
})();
