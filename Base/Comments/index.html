(function () {
  // BDVBurik 2024
  "use strict";

  let www = ``;
  let year;
  let namemovie;
  const urlEndTMDB = "?language=en-US&api_key=4ef0d7355d9ffb5151e987764708ce96";

  const tmdbApiUrl = "https://api.themoviedb.org/3/";
  let kp_prox = "https://worker-patient-dream-26d7.bdvburik.workers.dev:8443/";
  let url = "https://rezka.ag/ajax/get_comments/?t=1714093694732&news_id=";

  // Функция для создания и отображения индикатора загрузки
  function showLoadingIndicator() {
    let loadingDiv = document.createElement("div");
    loadingDiv.id = "loadingIndicator";
    loadingDiv.style.position = "fixed";
    loadingDiv.style.top = "0";
    loadingDiv.style.left = "0";
    loadingDiv.style.width = "100%";
    loadingDiv.style.height = "100%";
    loadingDiv.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
    loadingDiv.style.display = "flex";
    loadingDiv.style.alignItems = "center";
    loadingDiv.style.justifyContent = "center";
    loadingDiv.style.color = "white";
    loadingDiv.style.fontSize = "20px";
    loadingDiv.style.zIndex = "9999";
    loadingDiv.innerText = "Загрузка...";
    document.body.appendChild(loadingDiv);
  }

  // Функция для скрытия индикатора загрузки
  function hideLoadingIndicator() {
    let loadingDiv = document.getElementById("loadingIndicator");
    if (loadingDiv) {
      document.body.removeChild(loadingDiv);
    }
  }

  // Функция для поиска на сайте hdrezka
  async function searchRezka(name, ye) {
    showLoadingIndicator(); // Показываем индикатор загрузки

    try {
      let fc = await fetch(
        kp_prox +
          "https://hdrezka.ag/search/?do=search&subaction=search&q=" +
          name +
          (ye ? "+" + ye : ""),
        {
          method: "GET",
          headers: {
            "Content-Type": "text/html",
          },
        }
      ).then((response) => response.text());

      let dom = new DOMParser().parseFromString(fc, "text/html");

      let arr = Array.from(dom.getElementsByClassName("b-content__inline_item"));
      namemovie = arr[0].childNodes[3].innerText;

      comment_rezka(arr[0].dataset.id);
    } catch (error) {
      console.error("Ошибка поиска на hdrezka:", error);
    } finally {
      hideLoadingIndicator(); // Скрываем индикатор загрузки
    }
  }

  // Функция для получения английского названия фильма или сериала
  async function getEnTitle(id, type) {
    let url;

    if (type === "movie") {
      url = kp_prox + tmdbApiUrl + "movie/" + id + urlEndTMDB;
    } else {
      url = kp_prox + tmdbApiUrl + "tv/" + id + urlEndTMDB;
    }

    ennTitle(url);
  }

  async function ennTitle(url) {
    let enTitle;
    try {
      await fetch(url)
        .then((response) => response.json())
        .then((e) => (enTitle = e.title || e.name));
      searchRezka(normalizeTitle(enTitle), year);
    } catch (error) {
      console.error("Ошибка получения английского названия:", error);
    }
  }

  // Функция для очистки заголовка от лишних символов
  function cleanTitle(str) {
    return str.replace(/[\s.,:;’'`!?]+/g, " ").trim();
  }

  // Функция для нормализации заголовка
  function normalizeTitle(str) {
    return cleanTitle(
      str
        .toLowerCase()
        .replace(/[\-\u2010-\u2015\u2E3A\u2E3B\uFE58\uFE63\uFF0D]+/g, "-")
        .replace(/ё/g, "е")
    );
  }

  // Функция для получения комментариев с сайта rezka
  async function comment_rezka(id) {
    showLoadingIndicator(); // Показываем индикатор загрузки

    try {
      console.log(
        kp_prox +
          url +
          (id ? id : "1") +
          "&cstart=1&type=0&comment_id=0&skin=hdrezka"
      );
      let fc = await fetch(
        kp_prox +
          url +
          (id ? id : "1") +
          "&cstart=1&type=0&comment_id=0&skin=hdrezka",
        {
          method: "GET",
          headers: { "Content-Type": "text/plain" },
        }
      )
        .then((response) => response.json())
        .then((qwe) => qwe);

      let dom = new DOMParser().parseFromString(fc.comments, "text/html");
      dom
        .querySelectorAll(".ava, .actions, i, .share-link")
        .forEach((elem) => elem.remove());

      dom
        .querySelectorAll(".message")
        .forEach((e) => e.parentNode.parentNode.before(e));
      dom.querySelectorAll(".info").forEach((e) => {
        e.childNodes[5].remove();
        e.classList.add("myinfo");
        e.classList.remove("info");
      });

      let arr = dom.getElementsByClassName("comments-tree-list");
      www = arr[0].outerHTML;

      let Script = document.createElement("Script");
      Script.innerHTML = `function ShowOrHide(id) {var text = $("#" + id);text.prev(".title_spoiler").remove();text.css("display", "inline");}`;
      document.head.appendChild(Script);
      var modal = $(
        `<div> <div class="broadcast__text" style="text-align:left;"><div class="comment" style="margin-left: -15px;">` +
          www +
          "</div></div></div>"
      );
      let styleEl = document.createElement("style");
      styleEl.setAttribute("type", "text/css");
      styleEl.innerHTML = `
      .scroll--mask{
        margin-top: 10px;
      }
      .title_spoiler a {
    border-radius: 8px;
    background-color: #5d5b5b;
    color: #fff;
    padding: 0 2px 0 5px;
    position: relative;
    text-decoration: none;
    }
    .text_spoiler {
    background-color: #353333;
    }
    .comments-tree-item {
    list-style: none;
    margin: 0;
    padding: 0;
    }
    .b-comment .message {
    float: right;
    width: 100%;
    padding-bottom: 10px;
    }
    .myinfo {
    margin-top: 10px;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-between;
    font-size: 0.6em;
    color: #cfc9be;
    }
    div.text > div {
    display: ruby-text;
    padding-left: 1.2em;
    }
    `;
      document.head.appendChild(styleEl);

      var enabled = Lampa.Controller.enabled().name;
      Lampa.Modal.open({
        title: ``,
        html: modal,
        size: "large",
        style: "margin-top:10px;",
        mask: !0,
        onBack: function () {
          Lampa.Modal.close(), Lampa.Controller.toggle(enabled);
          $(".modal--large").remove();
          www = "";
        },
        onSelect: function () {},
      });
      $(".modal__head").after(
        `${namemovie}<button class="selector "  tabindex="0" style = "float: right;" type="button"  onclick="$('.modal--large').remove()"  data-dismiss="modal">&times;</button>`
      );
    } catch (error) {
      console.error("Ошибка получения комментариев:", error);
    } finally {
      hideLoadingIndicator(); // Скрываем индикатор загрузки
    }
  }

  // Функция для начала работы плагина
  function startPlugin() {
    window.comment_plugin = true;
    Lampa.Listener.follow("full", function (e) {
      if (e.type == "complite") {
        $(".button--comment").remove();
        $(".full-start-new__buttons").append(
          `<div class="full-start__button selector button--comment"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 24 24"><path d="M21 13h-2v-6h2v6zm-3-6h-2v6h2v-6zm-3 0h-2v6h2v-6zm-3 0h-2v6h2v-6zm-3 0h-2v6h2v-6zm6 10h2v-6h-2v6zm-3 0h2v-6h-2v6zm-3 0h2v-6h-2v6zm-3 0h2v-6h-2v6z"/></svg> Комментарии</div>`
        );

        $(".full-start__button.button--comment").on("click", function () {
          let title = document.querySelector("h1.full-start__title").innerText;
          let year = (document.querySelector(".full-start__meta") || {}).innerText.split(" ")[1];
          namemovie = normalizeTitle(title);
          year = year;
          searchRezka(namemovie, year);
        });
      }
    });
  }

  // Запуск плагина после загрузки страницы
  document.addEventListener("DOMContentLoaded", startPlugin);
})();
