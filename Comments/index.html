(function () {
    "use strict";

    let www = "<hr>";
    let urlEndTMDB = "?language=en-US&api_key=4ef0d7355d9ffb5151e987764708ce96";
    let year;
    let namemovie;
    let kp_prox = "https://worker-patient-dream-26d7.bdvburik.workers.dev/";
    let url = "https://hdrezka.website/ajax/get_comments/?t=1714093694732&news_id=";

    // Функция для поиска на сайте hdrezka
    async function searchRezka(name, ye) {
        let fc = await fetch(
            kp_prox +
            "https://hdrezka.website/search/?do=search&subaction=search&q=" +
            name +
            (ye ? "+" + ye : ""),
            {
                method: "GET",
                headers: {
                    "Content-Type": "text/html",
                },
            }
        ).then((response) => response.text());

        let dom = new DOMParser().parseFromString(fc, "text/html");

        let arr = Array.from(dom.getElementsByClassName("trailer show-trailer"));
        comment_rezka(arr[0].dataset.id);
    }

    // Функция для получения английского названия фильма или сериала
    async function getEnTitle(id) {
        let url;
        let enTitle;

        await fetch(
            kp_prox + "https://api.themoviedb.org/3/movie/" + id + urlEndTMDB,
            {
                method: "GET",
                headers: {
                    accept: "application/json",
                },
            }
        )
            .then((response) => response.json())
            .then((data) => {
                if (!data.release_date) {
                    url = kp_prox + "https://api.themoviedb.org/3/tv/" + id + urlEndTMDB;
                } else {
                    url =
                        kp_prox + "https://api.themoviedb.org/3/movie/" + id + urlEndTMDB;
                }
            });

        await fetch(url)
            .then((response) => response.json())
            .then((e) => (enTitle = e.title || e.name));
    }

    // Обработка комментариев
    .map((er) => er)
    .forEach((q) => {
        let text = q.childNodes[3].innerText;
        console.log(text.length, text);
        let spoilerIndex = text.indexOf("спойлер");
        if (spoilerIndex !== -1) {
            www +=
                "<div><div style = 'display: flex; justify-content: space-between; font-size: 0.6em; color:#cfc9be '><span>" +
                q.childNodes[1].children[1].innerText +
                "</span> <span >" +
                q.childNodes[1].children[2].innerText +
                "</span></div> <div style='padding-left:1.2em'>" +
                text.substring(0, spoilerIndex) +
                "<details open><summary>Спойлер</summary>" +
                text.substring(spoilerIndex) +
                "</details>" +
                "</div></div><hr> ";
        } else {
            www +=
                "<div><div style = 'display: flex; justify-content: space-between; font-size: 0.6em; color:#cfc9be '><span>" +
                q.childNodes[1].children[1].innerText +
                "</span> <span >" +
                q.childNodes[1].children[2].innerText +
                "</span></div> <div style='padding-left:1.2em'>" +
                text +
                "</div></div><hr> ";
        }
    });
})();
