(function () {
    'use strict';

    // Функция для получения текста с URL
    function getTextFromURL(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    callback(null, xhr.responseText);
                } else {
                    callback('Ошибка загрузки: ' + xhr.status);
                }
            }
        };
        xhr.open('GET', url, true);
        xhr.send();
        console.log('install', 'Запрос текста по URL:', url);
    }

    // Функция для установки плагина
    function installPlugin(name, url, author, description) {
        var pluginsArray = Lampa.Storage.get('plugins') || [];

        // Обработка имени автора
        author = (author.trim() === '' || !author.includes('://')) ? '@lampa' : author.match(/:\/\/([^\.]+)\./) ? '@' + RegExp.$1 : author.split(' ')[0];

        console.log('install', 'Устанавливаем плагин:', name);
        console.log('install', 'URL:', url);
        console.log('install', 'Автор:', author);
        console.log('install', 'Описание:', description);

        // Добавление плагина
        pluginsArray.push({
            author: author,
            url: url,
            name: name,
            status: 1,
            description: description
        });

        Lampa.Storage.set('plugins', pluginsArray);
        console.log('install', 'Плагин установлен:', name);
    }

    // Функция для обработки текста и извлечения данных
    function processFirstLineText(err, text) {
        if (err) {
            console.error('install', err);
            return;
        }

        var lines = text.split('\n');

        // Ищем первую строку, удовлетворяющую формату
        var firstLine = lines.find(function (line) {
            return line.trim() !== '' && line.includes('-');
        });

        if (firstLine) {
            var parts = firstLine.split(' - ');
            var id = parts[0].trim();
            var url = parts[1].trim();
            var authorURL = parts[2].trim();
            var name = parts[3].trim();

            // Получение имени автора
            var author = (authorURL.trim() === '' || !authorURL.includes('://')) ? '@lampa' : authorURL.match(/:\/\/([^\.]+)\./) ? '@' + RegExp.$1 : authorURL.split(' ')[0];

            // Устанавливаем плагин
            installPlugin(name, url, author, name);
        } else {
            console.error('install', 'Не удалось найти подходящую строку.');
        }
    }

    console.log('install', 'Запуск программы...');

    // Загружаем текст со страницы и обрабатываем его
    getTextFromURL('https://raw.githubusercontent.com/lat5/pl/main/plugins_list.txt', processFirstLineText);
})();
