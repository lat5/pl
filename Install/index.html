(function () {
    'use strict';

    // Функция для получения текста с URL
    function getTextFromURL(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    callback(null, xhr.responseText);
                } else {
                    callback('Ошибка загрузки: ' + xhr.status);
                }
            }
        };
        xhr.open('GET', url, true);
        xhr.send();
        console.log('install', 'Запрос текста по URL:', url);
    }

    // Функция для обработки текста и добавления плагинов в список
    function processPluginsText(err, text) {
        if (err) {
            console.error('install', err);
            return;
        }

        var lines = text.split('\n');
        lines.forEach(function (line) {
            console.log('install', 'Получена строка:', line);
        });

        var pluginsArray = Lampa.Storage.get('plugins') || [];
        var sectionRegex = /^\[.*\]$/; // Регулярное выражение для проверки секции
        var pluginRegex = /^(.*) - (.*) - (.*) - (.*)$/; // Регулярное выражение для извлечения данных о плагине

        lines.forEach(function (line) {
            if (sectionRegex.test(line)) {
                console.log('install', 'Обнаружена секция:', line);
                return; // Пропускаем секции
            }

            var match = pluginRegex.exec(line);
            if (match) {
                var name = match[1];
                var sourceURL = match[2];
                var sourceName = match[3];
                var description = match[4];

                console.log('install', 'Найден плагин:', name);
                pluginsArray.push({
                    author: 'lat5',
                    url: sourceURL,
                    name: name,
                    status: 1,
                    description: description,
                    version: '1.0.0'
                });
            }
        });

        Lampa.Storage.set('plugins', pluginsArray);
        console.log('install', 'Плагины добавлены:', pluginsArray);
    }

    console.log('install', 'Запуск плагина...');

    // Загружаем текст со страницы и обрабатываем его
    getTextFromURL('https://raw.githubusercontent.com/lat5/pl/main/plugins_list.txt', processPluginsText);
})();
